<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0,minimal-ui"><link rel="icon" type="image/x-icon" href="/favicon.ico"><link rel="alternate" type="application/rss+xml" title="zenxme" href="/atom.xml"><link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/6.1.1/css/all.min.css"><script src="https://cdn.staticfile.org/highlight.js/11.5.1/highlight.min.js"></script><script>!function(t){"use strict";!function(s){var e=window,i=document,r=t,c="".concat("https:"===i.location.protocol?"https://":"http://","sdk.51.la/js-sdk-pro.min.js"),n=i.createElement("script"),o=i.getElementsByTagName("script")[0];n.type="text/javascript",n.setAttribute("charset","UTF-8"),n.async=!0,n.src=c,n.id="LA_COLLECT",r.d=n;var a=function(){e.LA.ids.push(r)};e.LA?e.LA.ids&&a():(e.LA=t,e.LA.ids=[],a()),o.parentNode.insertBefore(n,o)}()}({id:"Jr1ziSrOWozk1Oug",ck:"Jr1ziSrOWozk1Oug"})</script><link rel="stylesheet" href="/css/tailwind.css"><link rel="stylesheet" href="/css/site.css"><script src="/js/site.js"></script><title>使用 pre-commit 自动格式化 python 代码 - zenxme</title><meta name="generator" content="Hexo 5.4.2"></head><body><nav class="flex justify-center border-b border-gray-200 h-14"><div class="container flex items-center justify-center"><div class="w-10 h-10"><a href="/"><img src="/favicon_transparent.png" alt="logo"></a></div><div class="relative flex content-center h-full ml-14"><a class="flex h-full font-bold items-center hover:text-blue-500" href="/">首页</a></div><div class="relative flex content-center h-full ml-14"><a class="flex h-full font-bold items-center hover:text-blue-500" href="/tags">标签</a></div><div class="relative flex content-center h-full ml-14"><a class="flex h-full font-bold items-center hover:text-blue-500" href="/about">关于</a></div></div></nav><div class="flex justify-center my-0 sm:my-4"><div class="container flex justify-center"><article id="article" class="hidden w-full px-4 py-4 pb-12 mx-0 border-0 border-gray-300 sm:rounded md:mx-1 md:w-5/6 lg:w-[1200px] md:px-8 lg:px-28 lg:py-8"><h1>使用 pre-commit 自动格式化 python 代码</h1><div class="flex justify-center mb-8 text-xs text-gray-500"><span class="mr-10">2021-06-28</span><div><a class="mr-4 hover:bg-gray-200" href="/tags/python/"><i class="align-middle fas fa-tag"></i> python </a><a class="mr-4 hover:bg-gray-200" href="/tags/pre-commit/"><i class="align-middle fas fa-tag"></i> pre-commit </a><a class="mr-4 hover:bg-gray-200" href="/tags/darker/"><i class="align-middle fas fa-tag"></i> darker</a></div></div><p></p><p>为了使代码风格统一，我们一般希望项目的开发人员使用同一套规则进行代码格式化，在使用 git 做版本管理的项目里，可以使用 git hooks 在提交时对代码进行处理。</p><p>关于 git hooks 的具体介绍，可以查看： <a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v2/%E8%87%AA%E5%AE%9A%E4%B9%89-Git-Git-%E9%92%A9%E5%AD%90">Git 钩子</a></p><blockquote><p>pre-commit 钩子在键入提交信息前运行。 它用于检查即将提交的快照，例如，检查是否有所遗漏，确保测试运行，以及核查代码。 如果该钩子以非零值退出，Git 将放弃此次提交，不过你可以用 git commit –no-verify 来绕过这个环节。 你可以利用该钩子，来检查代码风格是否一致（运行类似 lint 的程序）、尾随空白字符是否存在（自带的钩子就是这么做的），或新方法的文档是否适当。</p></blockquote><p>直接对 python 源文件进行格式化的工具有很多，black、autopep8、yapf 等等，以 black 为例，可以参考官方文档 <a target="_blank" rel="noopener" href="https://black.readthedocs.io/en/stable/integrations/source_version_control.html">Version control integration - Black Documention</a> 进行配置。</p><p>有点遗憾的是，这些工具都没有提供“只格式化修改的部分”这个功能。</p><p>对于有一些历史代码的项目，我们希望格式化工具只对自己改动的部分生效，而不是整个文件。因为一些上千行的历史代码经过格式化之后会产生非常多的变动，不利于代码 review。</p><p>在 black 项目里就有人提出了这样的需求：<a target="_blank" rel="noopener" href="https://github.com/psf/black/issues/830">[Feature Request] Allow command line option to only reformat specific lines</a>，而且得到了很多人的支持。目前似乎 black 的维护者不想加入这个功能，于是后面有其它的开发者基于 black 创建了一个 <a target="_blank" rel="noopener" href="https://github.com/akaihola/darker">darker</a> 的项目。</p><p>darker 封装了多个格式化和 lint 工具，而且提供配置可以自由选择，它找出和上次 commit 有不同的文件部分，然后分别调用格式化工具，再对结果进行整合。</p><p>下面简要列出安装和使用的步骤，更多的用法可以参考这几个工具的文档：</p><ol><li>安装 pre-commit: <code>python -m pip install pre-commit</code></li><li>新建 <code>.pre-commit-config.yaml</code>文件，用于 pre-commit 的配置：</li></ol><pre><code class="yml">repos:
-   repo: https://github.com/akaihola/darker
    rev: 1.5.0
    hooks:
    -   id: darker
        entry: bash -c &#39;darker &quot;$@&quot;; git add -u&#39; --
        additional_dependencies: [&#39;black&#39;, &#39;isort&#39;, &#39;flake8&#39;]
</code></pre><ol start="3"><li>新建<code>pyproject.toml</code>，用于 darker 的配置：</li></ol><pre><code class="toml">[tool.darker]
revision = &quot;HEAD&quot;
diff = false
check = false
isort = true
lint = [
    &quot;flake8&quot;,
]
log_level = &quot;INFO&quot;

[tool.black]
line-length = 120
target-version = [&#39;py36&#39;, &#39;py37&#39;, &#39;py38&#39;]
include = &#39;\.py$&#39;
skip-string-normalization = true
</code></pre><ol start="4"><li>运行<code>pre-commit install</code> 安装 hooks</li><li>和正常使用 git 一样，只要上面安装流程成功了即可，hooks 会自动在 commit 之前运行。</li></ol><p>默认情况下 pre-commit 修改了文件内容时，会导致 commit 流程终止，需要重新手动 add、commit，这个是 pre-commit 故意这么设计的。</p><p>为了避免这种麻烦的操作，上面第 2 步里的 entry 我改成了<code>bash -c &#39;darker &quot;$@&quot;; git add -u&#39; --</code>，每次格式化完之后重新 add。参考：</p><ul><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/58398995/black-as-pre-commit-hook-always-fails-my-commits">black as pre-commit hook always fails my commits</a></li><li><a target="_blank" rel="noopener" href="https://github.com/psf/black/issues/1857">Add pre-commit hook configuration option to always re-stage modified files so pre-commit doesn’t fail</a></li></ul><p></p></article></div></div></body></html>